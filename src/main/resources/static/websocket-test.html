<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - Collection Point Status</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }

        .section h2 {
            color: #555;
            margin-top: 0;
            font-size: 1.3em;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn-connect {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-disconnect {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-test {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-clear {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        input[type="text"], input[type="number"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .log-container {
            height: 300px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            background: white;
        }

        .log-entry.received {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .log-entry.sent {
            border-left-color: #ffc107;
            background: #fffef8;
        }

        .log-entry.error {
            border-left-color: #dc3545;
            background: #fff8f8;
        }

        .timestamp {
            color: #666;
            font-size: 11px;
        }

        .api-test {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn-preset {
            background: linear-gradient(45deg, #9C27B0, #673AB7);
            color: white;
            font-size: 12px;
            padding: 8px 16px;
        }

        @media (max-width: 768px) {
            .api-test {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
            }
            button, input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üîå WebSocket Test - Collection Status</h1>

    <!-- Connection Section -->
    <div class="section">
        <h2>üì° WebSocket Connection</h2>
        <div class="controls">
            <button class="btn-connect" onclick="connect()">Connect to WebSocket</button>
            <button class="btn-disconnect" onclick="disconnect()" disabled>Disconnect</button>
        </div>
        <div id="connectionStatus" class="status disconnected">‚ùå Disconnected</div>
        <small style="color: #666;">
            WebSocket URL: <span id="wsUrl">ws://localhost:8080/ws</span><br>
            Topic: /topic/collection-status
        </small>
    </div>

    <!-- API Test Section -->
    <div class="section">
        <h2>üß™ API Test (Call mark-completed)</h2>
        <div class="controls">
            <input type="number" id="jobRotationId" placeholder="Job Rotation ID" value="1">
            <button class="btn-test" onclick="callMarkCompletedAPI()">Call API & Test WebSocket</button>
        </div>

        <!-- Preset test buttons -->
        <div class="preset-buttons">
            <button class="btn-preset" onclick="testScenario('success')">Test Success (ID: 1)</button>
            <button class="btn-preset" onclick="testScenario('notfound')">Test Not Found (ID: 999)</button>
            <button class="btn-preset" onclick="testScenario('missing')">Test Missing ID</button>
            <button class="btn-preset" onclick="testScenario('completed')">Test Already Completed</button>
        </div>

        <div class="api-test">
            <div>
                <h3>üì§ API Response:</h3>
                <div id="apiResponse" class="log-container" style="height: 200px;"></div>
            </div>
            <div>
                <h3>üì® WebSocket Message:</h3>
                <div id="websocketResponse" class="log-container" style="height: 200px;"></div>
            </div>
        </div>
    </div>

    <!-- Logs Section -->
    <div class="section">
        <h2>üìã All Logs</h2>
        <div class="controls">
            <button class="btn-clear" onclick="clearLogs()">Clear All Logs</button>
            <button class="btn-test" onclick="pingTest()">Ping Test</button>
        </div>
        <div id="logs" class="log-container"></div>
    </div>
</div>

<script>
    let stompClient = null;
    let connected = false;
    const BASE_URL = window.location.origin; // T·ª± ƒë·ªông l·∫•y URL hi·ªán t·∫°i

    function connect() {
        const socket = new SockJS(BASE_URL + '/ws');
        stompClient = Stomp.over(socket);

        stompClient.debug = null;

        const token = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJodW9uZ3QiLCJpYXQiOjE3NDk0NDA0OTAsImV4cCI6MTc1MDA0NTI5MH0.E5ZCg5mXgIOlQYfV9mvO0YZcVaYcU9Xslu_43k7iQAw'; // L∆∞u token v√†o ƒë√¢y
        addLog('üîÑ Connecting to ' + BASE_URL + '/ws...', 'sent');

        stompClient.connect(
            {
                Authorization: "Bearer "+token
            },
            function (frame) {
                connected = true;
                updateConnectionStatus(true);
                addLog('‚úÖ Connected successfully!', 'received');

                stompClient.subscribe('/topic/collection-status', function (message) {
                    const data = JSON.parse(message.body);
                });

                addLog('üì° Subscribed to /topic/collection-status', 'received');
            },
            function (error) {
                connected = false;
                updateConnectionStatus(false);
                addLog('‚ùå Connection error: ' + error, 'error');
            }
        );
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
            connected = false;
            updateConnectionStatus(false);
            addLog('üîå Disconnected from WebSocket', 'sent');
        }
    }

    function updateConnectionStatus(isConnected) {
        const statusElement = document.getElementById('connectionStatus');
        const connectBtn = document.querySelector('.btn-connect');
        const disconnectBtn = document.querySelector('.btn-disconnect');

        if (isConnected) {
            statusElement.textContent = '‚úÖ Connected to WebSocket';
            statusElement.className = 'status connected';
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
        } else {
            statusElement.textContent = '‚ùå Disconnected';
            statusElement.className = 'status disconnected';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
        }
    }

    function callMarkCompletedAPI() {
        const jobRotationId = document.getElementById('jobRotationId').value;

        if (!connected) {
            alert('Please connect to WebSocket first!');
            return;
        }

        if (!jobRotationId && jobRotationId !== 0) {
            alert('Please enter Job Rotation ID');
            return;
        }

        addLog('üöÄ Calling API: POST /api/mark-completed with jobRotationId: ' + jobRotationId, 'sent');

        // Clear previous responses
        document.getElementById('websocketResponse').innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">‚è≥ Waiting for WebSocket message...</div>';

        const payload = jobRotationId ? { jobRotationId: parseInt(jobRotationId) } : {};
        const token = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJodW9uZ3QiLCJpYXQiOjE3NDk0NDA0OTAsImV4cCI6MTc1MDA0NTI5MH0.E5ZCg5mXgIOlQYfV9mvO0YZcVaYcU9Xslu_43k7iQAw';
        fetch(BASE_URL + '/api/collection-points/mark-completed', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                addLog('üì§ API Response: ' + JSON.stringify(data, null, 2), 'received');

                // Display API response
                const apiResponse = document.getElementById('apiResponse');
                const statusClass = data.success ? 'received' : 'error';
                const statusIcon = data.success ? '‚úÖ' : '‚ùå';

                apiResponse.innerHTML = `
                    <div class="log-entry ${statusClass}">
                        <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                        <strong>${statusIcon} API Response:</strong><br><br>
                        Success: <strong>${data.success}</strong><br>
                        Message: ${data.message}<br>
                        ${data.jobRotationId ? 'Job Rotation ID: ' + data.jobRotationId + '<br>' : ''}
                        ${data.status ? 'Status: <strong>' + data.status + '</strong><br>' : ''}
                        ${data.updatedAt ? 'Updated At: ' + new Date(data.updatedAt).toLocaleString() : ''}
                    </div>
                `;

                if (data.success) {
                    addLog('‚úÖ API call successful - WebSocket message should arrive shortly!', 'received');
                    setTimeout(() => {
                        const wsResp = document.getElementById('websocketResponse');
                        if (wsResp.innerHTML.includes('Waiting for WebSocket')) {
                            wsResp.innerHTML = '<div style="color: #f44336; padding: 20px; text-align: center;">‚ö†Ô∏è No WebSocket message received yet. Check server logs.</div>';
                        }
                    }, 3000);
                } else {
                    addLog('‚ùå API call failed: ' + data.message, 'error');
                    document.getElementById('websocketResponse').innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">No WebSocket message expected (API failed)</div>';
                }
            })
            .catch(error => {
                addLog('‚ùå API Error: ' + error.message, 'error');

                document.getElementById('apiResponse').innerHTML = `
                    <div class="log-entry error">
                        <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                        <strong>‚ùå API Error:</strong><br><br>
                        ${error.message}
                    </div>
                `;
            });
    }

    function testScenario(scenario) {
        const jobIdInput = document.getElementById('jobRotationId');

        switch(scenario) {
            case 'success':
                jobIdInput.value = '1';
                addLog('üß™ Testing SUCCESS scenario (ID: 1)', 'sent');
                break;
            case 'notfound':
                jobIdInput.value = '999999';
                addLog('üß™ Testing NOT FOUND scenario (ID: 999999)', 'sent');
                break;
            case 'missing':
                jobIdInput.value = '';
                addLog('üß™ Testing MISSING ID scenario', 'sent');
                break;
            case 'completed':
                jobIdInput.value = '3';
                addLog('üß™ Testing ALREADY COMPLETED scenario (ID: 3)', 'sent');
                break;
        }

        setTimeout(() => callMarkCompletedAPI(), 500);
    }

    function pingTest() {
        if (!connected) {
            addLog('‚ùå Not connected to WebSocket', 'error');
            return;
        }

        addLog('üèì Ping test - checking connection...', 'sent');
        // Simple connection test
        try {
            addLog('‚úÖ WebSocket connection is active', 'received');
        } catch (error) {
            addLog('‚ùå WebSocket connection error: ' + error.message, 'error');
        }
    }

    function addLog(message, type = '') {
        const logs = document.getElementById('logs');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry ' + type;
        logEntry.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div>${message}</div>
            `;
        logs.appendChild(logEntry);
        logs.scrollTop = logs.scrollHeight;
    }

    function clearLogs() {
        document.getElementById('logs').innerHTML = '';
        document.getElementById('apiResponse').innerHTML = '';
        document.getElementById('websocketResponse').innerHTML = '';
        addLog('üßπ Logs cleared', 'sent');
    }

    // Initialize
    window.onload = function() {
        document.getElementById('wsUrl').textContent = BASE_URL + '/ws';

        addLog('üöÄ WebSocket Test Page Loaded', 'sent');
        addLog('üìù Instructions:', 'sent');
        addLog('1. Click "Connect to WebSocket" first', 'sent');
        addLog('2. Use preset test buttons or enter custom Job Rotation ID', 'sent');
        addLog('3. Click "Call API & Test WebSocket"', 'sent');
        addLog('4. Watch for both API response and WebSocket message', 'sent');
        addLog('', 'sent');
        addLog('üí° Make sure your backend has test data in job_rotation table', 'sent');
    };

    // Auto-connect on page load (optional)
    // setTimeout(connect, 1000);
</script>
</body>
</html>